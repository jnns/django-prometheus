



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.0">
    
    
      
        <title>Exports - django-prometheus</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.1b62728e.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#exports" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="django-prometheus" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              django-prometheus
            </span>
            <span class="md-header-nav__topic">
              
                Exports
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/korfuri/django-prometheus/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="django-prometheus" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    django-prometheus
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/korfuri/django-prometheus/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Usage" class="md-nav__link">
      Usage
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Exports
      </label>
    
    <a href="./" title="Exports" class="md-nav__link md-nav__link--active">
      Exports
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#default-exporting-metrics-as-a-django-view" class="md-nav__link">
    Default: exporting /metrics as a Django view
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exporting-metrics-in-a-dedicated-thread" class="md-nav__link">
    Exporting /metrics in a dedicated thread
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exporting-metrics-in-a-wsgi-application-with-multiple-processes-per-process" class="md-nav__link">
    Exporting /metrics in a WSGI application with multiple processes per process
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exporting-metrics-in-a-wsgi-application-with-multiple-processes-globally" class="md-nav__link">
    Exporting /metrics in a WSGI application with multiple processes globally
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../CONTRIBUTING/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../CHANGELOG/" title="Changelog" class="md-nav__link">
      Changelog
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#default-exporting-metrics-as-a-django-view" class="md-nav__link">
    Default: exporting /metrics as a Django view
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exporting-metrics-in-a-dedicated-thread" class="md-nav__link">
    Exporting /metrics in a dedicated thread
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exporting-metrics-in-a-wsgi-application-with-multiple-processes-per-process" class="md-nav__link">
    Exporting /metrics in a WSGI application with multiple processes per process
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exporting-metrics-in-a-wsgi-application-with-multiple-processes-globally" class="md-nav__link">
    Exporting /metrics in a WSGI application with multiple processes globally
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/korfuri/django-prometheus/edit/master/docs/exports.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="exports">Exports</h1>
<h2 id="default-exporting-metrics-as-a-django-view">Default: exporting /metrics as a Django view</h2>
<p><code>/metrics</code> can be exported as a Django view very easily. Simply
<code>include('django_prometheus.urls')</code> with no prefix like so:</p>
<div class="codehilite"><pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">...</span>
    <span class="n">url</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;django_prometheus.urls&#39;</span><span class="p">)),</span>
<span class="p">]</span>
</pre></div>


<p>This will reserve the <code>/metrics</code> path on your server. This may be a
problem for you, so you can use a prefix. For instance, the following
will export the metrics at <code>/monitoring/metrics</code> instead. You will
need to configure Prometheus to use that path instead of the default.</p>
<div class="codehilite"><pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">...</span>
    <span class="n">url</span><span class="p">(</span><span class="s1">&#39;^monitoring/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;django_prometheus.urls&#39;</span><span class="p">)),</span>
<span class="p">]</span>
</pre></div>


<h2 id="exporting-metrics-in-a-dedicated-thread">Exporting /metrics in a dedicated thread</h2>
<p>To ensure that issues in your Django app do not affect the monitoring,
it is recommended to export <code>/metrics</code> in an HTTPServer running in a
daemon thread. This will prevent that problems such as thread
starvation or low-level bugs in Django do not affect the export of
your metrics, which may be more needed than ever if these problems
occur.</p>
<p>It can be enabled by adding the following line in your <code>settings.py</code>:</p>
<div class="codehilite"><pre><span></span><span class="n">PROMETHEUS_METRICS_EXPORT_PORT</span> <span class="o">=</span> <span class="mi">8001</span>
<span class="n">PROMETHEUS_METRICS_EXPORT_ADDRESS</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># all addresses</span>
</pre></div>


<p>However, by default this mechanism is disabled, because it is not
compatible with Django's autoreloader. The autoreloader is the feature
that allows you to edit your code and see the changes
immediately. This works by forking multiple processes of Django, which
would compete for the port. As such, this code will assert-fail if the
autoreloader is active.</p>
<p>You can run Django without the autoreloader by passing <code>-noreload</code> to
<code>manage.py</code>. If you decide to enable the thread-based exporter in
production, you may wish to modify your manage.py to ensure that this
option is always active:</p>
<div class="codehilite"><pre><span></span>    <span class="n">execute_from_command_line</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;--noreload&#39;</span><span class="p">])</span>
</pre></div>


<h2 id="exporting-metrics-in-a-wsgi-application-with-multiple-processes-per-process">Exporting /metrics in a WSGI application with multiple processes per process</h2>
<p>If you're using WSGI (e.g. with uwsgi or with gunicorn) and multiple
Django processes, using either option above won't work, as requests
using the Django view would just go to an inconsistent backend each
time, and exporting on a single port doesn't work.</p>
<p>The following settings can be used instead:</p>
<div class="codehilite"><pre><span></span><span class="n">PROMETHEUS_METRICS_EXPORT_PORT_RANGE</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8001</span><span class="p">,</span> <span class="mi">8050</span><span class="p">)</span>
</pre></div>


<p>This will make Django-Prometheus try to export /metrics on port
8001. If this fails (i.e. the port is in use), it will try 8002, then
8003, etc.</p>
<p>You can then configure Prometheus to collect metrics on as many
targets as you have workers, using each port separately.</p>
<h2 id="exporting-metrics-in-a-wsgi-application-with-multiple-processes-globally">Exporting /metrics in a WSGI application with multiple processes globally</h2>
<p>In some WSGI applications, workers are short lived (less than a minute), so some
are never scraped by prometheus by default. Prometheus client already provides
a nice system to aggregate them using the env variable: <code>prometheus_multiproc_dir</code>
which will configure the directory where metrics will be stored as files per process.</p>
<p>Configuration in uwsgi would look like:</p>
<div class="codehilite"><pre><span></span><span class="na">env</span> <span class="o">=</span> <span class="s">prometheus_multiproc_dir=/path/to/django_metrics</span>
</pre></div>


<p>You can also set this environment variable elsewhere such as in a kubernetes manifest.
Note that the environment variable is lower_case.</p>
<p>Setting this will create four files (one for counters, one for summaries, ...etc)
for each pid used. In uwsgi, the number of different pids used can be quite large
(the pid change every time a worker respawn). To prevent having thousand of files
created, it's possible to create file using worker ids rather than pids.</p>
<p>You can change the function used for identifying the process to use the uwsgi worker_id.
Modify this in settings before any metrics are created:</p>
<div class="codehilite"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">prometheus_client</span>
    <span class="kn">import</span> <span class="nn">uwsgi</span>
    <span class="n">prometheus_client</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ValueClass</span> <span class="o">=</span> <span class="n">prometheus_client</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">MultiProcessValue</span><span class="p">(</span>
        <span class="n">_pidFunc</span><span class="o">=</span><span class="n">uwsgi</span><span class="o">.</span><span class="n">worker_id</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>  <span class="c1"># not running in uwsgi</span>
</pre></div>


<p>Note that this code uses internal interfaces of prometheus_client.
The underlying implementation may change.</p>
<p>The number of resulting files will be:
number of processes * 4 (counter, histogram, gauge, summary)</p>
<p>Be aware that by default this will generate a large amount of file descriptors:
Each worker will keep 3 file descriptors for each files it created.</p>
<p>Since these files will be written often, you should consider mounting this directory
as a <code>tmpfs</code> or using a subdir of an existing one such as <code>/run/</code> or <code>/var/run/</code>.</p>
<p>If uwsgi is not using lazy-apps (lazy-apps = true), there will be a
file descriptors leak (tens to hundreds of fds on a single file) due
to the way uwsgi forks processes to create workers.</p>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href=".." title="Usage" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Usage
              </span>
            </div>
          </a>
        
        
          <a href="../CONTRIBUTING/" title="Contributing" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Contributing
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.808e90bb.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>